name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  STELLAR_NETWORK: testnet
  STELLAR_RPC_URL: https://soroban-testnet.stellar.org
  STELLAR_NETWORK_PASSPHRASE: "Test SDF Network ; September 2015"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libdbus-1-dev libudev-dev pkg-config

      - name: Install Stellar CLI
        run: |
          cargo install stellar-cli --locked
          stellar --version

      - name: Fund deployer account via Friendbot
        env:
          STELLAR_SECRET_KEY: ${{ secrets.STELLAR_SECRET_KEY }}
        run: |
          # Get public key from secret key
          PUBLIC_KEY=$(stellar keys address "$STELLAR_SECRET_KEY")
          echo "Funding account: $PUBLIC_KEY"
          # Fund via Friendbot (ignore errors if already funded)
          curl -s "https://friendbot.stellar.org?addr=$PUBLIC_KEY" || true

      - name: Build theme contract
        run: |
          cd contracts/theme
          cargo build --release --target wasm32-unknown-unknown

      - name: Build todo contract (initial)
        run: |
          cd contracts/todo
          cargo build --release --target wasm32-unknown-unknown

      - name: Deploy theme contract
        id: deploy-theme
        env:
          STELLAR_SECRET_KEY: ${{ secrets.STELLAR_SECRET_KEY }}
        run: |
          THEME_ID=$(stellar contract deploy \
            --wasm contracts/theme/target/wasm32-unknown-unknown/release/soroban_render_theme.wasm \
            --network testnet \
            --source "$STELLAR_SECRET_KEY")
          echo "contract_id=$THEME_ID" >> $GITHUB_OUTPUT
          echo "Theme contract deployed: $THEME_ID"

      - name: Update todo contract with theme ID
        run: |
          THEME_ID="${{ steps.deploy-theme.outputs.contract_id }}"
          echo "Patching todo contract with theme ID: $THEME_ID"
          # Replace any 56-character contract ID after "{{include contract=" with the new theme ID
          sed -i "s/{{include contract=[A-Z0-9]\{56\}/{{include contract=$THEME_ID/g" contracts/todo/src/lib.rs
          # Verify the change
          grep -o "{{include contract=[A-Z0-9]*" contracts/todo/src/lib.rs | head -1

      - name: Rebuild todo contract with new theme ID
        run: |
          cd contracts/todo
          cargo build --release --target wasm32-unknown-unknown

      - name: Deploy todo contract
        id: deploy-todo
        env:
          STELLAR_SECRET_KEY: ${{ secrets.STELLAR_SECRET_KEY }}
        run: |
          TODO_ID=$(stellar contract deploy \
            --wasm contracts/todo/target/wasm32-unknown-unknown/release/soroban_render_todo.wasm \
            --network testnet \
            --source "$STELLAR_SECRET_KEY")
          echo "contract_id=$TODO_ID" >> $GITHUB_OUTPUT
          echo "Todo contract deployed: $TODO_ID"

      - name: Initialize todo contract
        env:
          STELLAR_SECRET_KEY: ${{ secrets.STELLAR_SECRET_KEY }}
        run: |
          stellar contract invoke \
            --id ${{ steps.deploy-todo.outputs.contract_id }} \
            --network testnet \
            --source "$STELLAR_SECRET_KEY" \
            -- init || echo "Init may have already been called"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build library
        run: pnpm --filter @soroban-render/core build

      - name: Run tests
        run: pnpm test

      - name: Generate production config
        run: |
          cat > apps/demo/.env.production << EOF
          # Auto-generated by GitHub Actions
          # Theme contract: ${{ steps.deploy-theme.outputs.contract_id }}
          VITE_CONTRACT_ID=${{ steps.deploy-todo.outputs.contract_id }}
          VITE_NETWORK=testnet
          EOF
          echo "Generated .env.production:"
          cat apps/demo/.env.production

      - name: Build demo
        run: pnpm --filter demo build

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: apps/demo/dist

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
